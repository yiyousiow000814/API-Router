name: CI

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, converted_to_draft]
    paths-ignore:
      - "**.md"
      - "docs/**"
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  pr_gate:
    name: PR Gate
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: PR Gate no-op
        run: echo "PR Gate (event=${{ github.event_name }}, action=${{ github.event.action }})"

  changes:
    needs: pr_gate
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    outputs:
      run_ci: ${{ steps.filter.outputs.run_ci }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect relevant changes
        id: filter
        run: |
          if [ "${{ github.event_name }}" != 'pull_request' ]; then
            echo "run_ci=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BASE_SHA='${{ github.event.pull_request.base.sha }}'
          HEAD_SHA='${{ github.event.pull_request.head.sha }}'

          git fetch --no-tags --prune --depth=2 origin "$BASE_SHA"
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")

          run_ci=false
          for file in $CHANGED_FILES; do
            case "$file" in
              .github/*|.github/**|src-tauri/*|src-tauri/**|src/*|src/**|package.json|package-lock.json)
                run_ci=true
                break
                ;;
            esac
          done

          echo "run_ci=$run_ci" >> "$GITHUB_OUTPUT"

  lint:
    needs: changes
    if: needs.changes.outputs.run_ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install Linux system deps (Tauri)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev

      - name: Node install
        run: npm ci

      - name: Web build
        run: npm run build

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust format (check)
        run: cargo fmt --manifest-path src-tauri/Cargo.toml --check

      - name: Rust clippy
        run: cargo clippy --manifest-path src-tauri/Cargo.toml -- -D warnings

  test:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Rust tests
        run: cargo test --manifest-path src-tauri/Cargo.toml --locked
